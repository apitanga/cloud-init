#!/bin/bash

domain=pitanga.org
tower=$(dig +short _cm._tcp.${domain} srv | awk '{print $4}')

retry_attempts=10
attempt=0
while [[ $attempt -lt $retry_attempts ]]
do
  status_code=`curl -s -i --data "host_config_key={{ host_config_id }} https://$tower/api/v2/job_templates/{{ template_id }}/callback/ | head -n 1 | awk '{print $2}'`
  if [[ $status_code == 202 ]]
    then
    exit 0
  fi
  attempt=$(( attempt + 1 ))
  logger "bootstrap: ${status_code} received... retrying in 30 seconds (Attempt ${attempt})"
  sleep 30
done
exit 1
